# Ansible playbook
---
- hosts: default
  become: true
  gather_facts: False

  vars:
    hostname: x509tosaml
    domain: example.org
    fqdn: "{{ hostname }}.{{ domain }}"
    #docroot: /opt/x509tosaml/www
    docroot: /vagrant/www

  remote_user: vagrant

  tasks:
  - name: install python 2
    raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)

  - name: install apache and modules
    apt: name={{ item }} update_cache=yes state=latest
    with_items:
      - ntp
      - apache2
      - libapache2-mod-php

  # Apache

  - name: Start apache Service
    service: name=apache2 enabled=true

  - name: enabled mod_ssl
    apache2_module: name=ssl state=present
    notify:
    - restart apache2

  - name: create virtual host file
    template: src=apache2/vhost.conf dest=/etc/apache2/sites-available/{{ fqdn }}.conf
    notify:
    - restart apache2

  - name: create key pair
    command: openssl genrsa -out /etc/ssl/private/{{ fqdn }}.pem 2048
    args:
      creates: /etc/ssl/private/{{ fqdn }}.pem
    notify:
    - restart apache2

  - name: create self-signed certificate
    command: openssl req -new -x509 -subj '/CN={{ fqdn }}' -key /etc/ssl/private/{{ fqdn }}.pem -out /etc/ssl/certs/{{ fqdn }}.pem -days 3650
    args:
      creates: /etc/ssl/certs/{{ fqdn }}.pem
    notify:
    - restart apache2

  - name: a2ensite {{ fqdn }}
    command: a2ensite {{ fqdn }}
    args:
      creates: /etc/apache2/sites-enabled/{{ fqdn }}.conf
    notify:
    - restart apache2

  handlers:

  - name: restart apache2
    service: name=apache2 state=restarted
